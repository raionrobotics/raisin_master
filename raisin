#!/usr/bin/env bash
set -euo pipefail

# RAISIN wrapper script for easier command-line usage.
# Intended to be symlinked into your PATH as `raisin`.

# Resolve symlinks so this works when `raisin` is symlinked into PATH.
SOURCE="${BASH_SOURCE[0]}"
while [[ -h "$SOURCE" ]]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ "$SOURCE" != /* ]] && SOURCE="${DIR}/${SOURCE}"
done
DEFAULT_SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"

# Prefer the RAISIN repo that contains the current working directory (useful when
# multiple copies of this repo exist). We detect a repo root by the presence of
# `raisin.py` and the `commands/` package.
SCRIPT_DIR="${DEFAULT_SCRIPT_DIR}"
search_dir="${PWD}"
while [[ -n "${search_dir}" && "${search_dir}" != "/" ]]; do
  if [[ -f "${search_dir}/raisin.py" && -d "${search_dir}/commands" ]]; then
    SCRIPT_DIR="${search_dir}"
    break
  fi
  search_dir="$(dirname "${search_dir}")"
done

if [[ "${1:-}" == "--install" ]]; then
  target_dir="${HOME}/.local/bin"
  mkdir -p "$target_dir"
  install_path="${target_dir}/raisin"
  # Install a copy (not a symlink) so it keeps working even if the repo is moved.
  src_path="${SCRIPT_DIR}/raisin"
  if [[ ! -f "${src_path}" ]]; then
    src_path="${DEFAULT_SCRIPT_DIR}/raisin"
  fi
  if command -v realpath >/dev/null 2>&1; then
    src_real="$(realpath "${src_path}")"
    dst_real="$(realpath "${install_path}" 2>/dev/null || true)"
  else
    src_real="$(cd -P "$(dirname "${src_path}")" && pwd)/$(basename "${src_path}")"
    if [[ -e "${install_path}" ]]; then
      dst_real="$(cd -P "$(dirname "${install_path}")" && pwd)/$(basename "${install_path}")"
    else
      dst_real=""
    fi
  fi

  if [[ -n "${dst_real}" && "${dst_real}" == "${src_real}" ]]; then
    chmod +x "${install_path}"
    echo "Already installed: ${install_path}"
    echo "If needed, add to PATH: export PATH=\"${HOME}/.local/bin:\$PATH\""
    exit 0
  fi

  if ! rm -f "${install_path}"; then
    echo "❌ Error: cannot overwrite ${install_path}. Check permissions/ownership." >&2
    exit 1
  fi
  if ! cp -f "${src_path}" "${install_path}"; then
    echo "❌ Error: failed to install wrapper to ${install_path}." >&2
    exit 1
  fi
  chmod +x "${install_path}"
  echo "Installed: ${install_path}"
  echo "If needed, add to PATH: export PATH=\"${HOME}/.local/bin:\$PATH\""
  exit 0
fi

if [[ "${1:-}" == "--where" || "${1:-}" == "--which" ]]; then
  echo "raisin wrapper: ${DEFAULT_SCRIPT_DIR}/raisin"
  echo "selected repo:  ${SCRIPT_DIR}"
  echo "raisin.py:      ${SCRIPT_DIR}/raisin.py"
  echo "config:         ${SCRIPT_DIR}/configuration_setting.yaml"
  exit 0
fi

python_bin="${RAISIN_PYTHON:-}"
if [[ -z "${python_bin}" ]]; then
  if [[ -x "${SCRIPT_DIR}/.venv/bin/python" ]]; then
    python_bin="${SCRIPT_DIR}/.venv/bin/python"
  elif [[ -x "${SCRIPT_DIR}/venv/bin/python" ]]; then
    python_bin="${SCRIPT_DIR}/venv/bin/python"
  else
    python_bin="$(command -v python3 || true)"
  fi
fi

if [[ -z "${python_bin}" ]]; then
  echo "❌ Error: python3 not found. Install Python 3 or set RAISIN_PYTHON." >&2
  exit 1
fi

exec "${python_bin}" "${SCRIPT_DIR}/raisin.py" "$@"
